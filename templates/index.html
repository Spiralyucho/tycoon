<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë©”ëª¨ì¥ íƒ€ì´ì¿¤ + ì¶”ë¦¬</title>
<style>
body { background:#111; color:#eee; font-family:sans-serif; padding:20px }
button { margin:4px; padding:8px }
#log { height:200px; overflow:auto; background:#222; padding:10px }
.spy { color:#ff5555; font-weight:bold }
canvas { background:#222; margin-top:10px }
</style>
</head>
<body>

<h1>ğŸª ë©”ëª¨ì¥ íƒ€ì´ì¿¤ + ğŸ•µï¸ ì¶”ë¦¬</h1>

<div id="status"></div>

<button onclick="act('work')">ì¥ì‚¬í•˜ê¸°</button>
<button onclick="act('upgrade')">ìë™ ìˆ˜ìµ ì—…ê·¸ë ˆì´ë“œ</button>
<button onclick="act('reputation')">í‰íŒ ê´€ë¦¬</button>
<button onclick="act('hire_staff')">ì§ì› ê³ ìš©</button>
<button onclick="act('hire_security')">ë³´ì•ˆ ìš”ì›</button>
<button onclick="act('investigate_spy')">ìŠ¤íŒŒì´ ì¡°ì‚¬ (100)</button>
<button onclick="act('purge_spy')">ìŠ¤íŒŒì´ ì œê±° (300)</button>

<h3>ğŸ“œ ë¡œê·¸ (ìŠ¤íŒŒì´ëŠ” ë¹¨ê°„ìƒ‰)</h3>
<div id="log"></div>

<h3>ğŸ“ˆ 3ë¶„ ìˆ˜ìµ ê·¸ë˜í”„</h3>
<canvas id="chart" width="420" height="200"></canvas>

<h3>ğŸ•µï¸ ë°°ì‹ ì ì¶”ë¦¬</h3>
<button onclick="guess('ì§ì›A')">ì§ì›A</button>
<button onclick="guess('ì§ì›B')">ì§ì›B</button>
<button onclick="guess('ì§ì›C')">ì§ì›C</button>
<div id="suspect_result"></div>

<script>
async function refresh() {
    const res=await fetch("/state");
    const s=await res.json();
    document.getElementById("status").innerHTML=`
        ğŸ’° ëˆ: ${s.money}<br>
        â­ í‰íŒ: ${s.reputation}<br>
        âš™ ìë™ë ˆë²¨: ${s.auto_level}<br>
        ğŸ‘¥ ì§ì›: ${s.staff} | ğŸ›¡ ë³´ì•ˆ: ${s.security}<br>
        ğŸ•µï¸ ìŠ¤íŒŒì´ ìƒíƒœ: ${s.spy_active ? `<span style="color:red">ì¹¨íˆ¬ ì¤‘ (ìœ„í—˜ë„ ${s.spy_level})</span>`:"ì•ˆì „"}<br>
        ğŸ•µï¸ ë‚´ë¶€ ì˜ì‹¬ì: ${s.internal_suspect?s.internal_suspect:"ì—†ìŒ"}
    `;
    document.getElementById("log").innerHTML=
        s.logs.slice(-15).reverse().map(l=>l.includes("ìŠ¤íŒŒì´")?`<div class="spy">${l}</div>`:`<div>${l}</div>`).join("");
    drawChart(s.income_history);
}

function drawChart(data){
    const c=document.getElementById("chart");
    const ctx=c.getContext("2d");
    ctx.clearRect(0,0,c.width,c.height);
    if(data.length<1) return;
    const max=Math.max(...data,10);
    const stepX=c.width/Math.max(1,data.length-1);
    ctx.beginPath();
    ctx.moveTo(0,c.height-(data[0]/max)*c.height);
    data.forEach((v,i)=>ctx.lineTo(i*stepX,c.height-(v/max)*c.height));
    ctx.strokeStyle="#4caf50";
    ctx.stroke();
}

async function act(action){
    await fetch("/action",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action})});
    refresh();
}

async function guess(name){
    const res=await fetch("/suspect",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({guess:name})});
    const data=await res.json();
    document.getElementById("suspect_result").innerText=data.result;
    refresh();
}

setInterval(refresh,1000);
refresh();
</script>

</body>
</html>
